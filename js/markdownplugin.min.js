tinymce.PluginManager.add("markdown",function(e){e.addButton("markdown",{text:"Mâ†“",tooltip:"Markdown",icon:!1,onclick:function(){tinyMCE.activeEditor.setContent("<pre>"+toMarkdown(tinyMCE.activeEditor.getContent()+"</pre>"),{format:"raw"})}}),e.addMenuItem("markdown",{text:"Markdown",context:"format",onclick:function(){tinyMCE.activeEditor.setContent("<pre>"+toMarkdown(tinyMCE.activeEditor.getContent()+"</pre>"),{format:"raw"})}})});var toMarkdown=function(e){function t(e,t){var n="void"===t.type?"<"+t.tag+"\\b([^>]*)\\/?>":"<"+t.tag+"\\b([^>]*)>([\\s\\S]*?)<\\/"+t.tag+">",r=new RegExp(n,"gi"),a="";return a="string"==typeof t.replacement?e.replace(r,t.replacement):e.replace(r,function(e,n,r,a){return t.replacement.call(this,e,n,r,a)})}function n(e){return new RegExp(e+"\\s*=\\s*[\"']?([^\"']*)[\"']?","i")}function r(e){return e=e.replace(/<(ul|ol)\b[^>]*>([\s\S]*?)<\/\1>/gi,function(e,t,n){var r=n.split("</li>");for(r.splice(r.length-1,1),p=0,i=r.length;i>p;p++)if(r[p]){var a="ol"===t?p+1+".  ":"*   ";r[p]=r[p].replace(/\s*<li[^>]*>([\s\S]*)/i,function(e,t){return t=t.replace(/^\s+/,""),t=t.replace(/\n\n/g,"\n\n    "),t=t.replace(/\n([ ]*)+(\*|\d+\.) /g,"\n$1    $2 "),a+t})}return r.join("\n")}),"\n\n"+e.replace(/[ \t]+\n|\s+$/g,"")}function a(e){return e=e.replace(/<blockquote\b[^>]*>([\s\S]*?)<\/blockquote>/gi,function(e,t){return t=t.replace(/^\s+|\s+$/g,""),t=c(t),t=t.replace(/^/gm,"> "),t=t.replace(/^(>([ \t]{2,}>)+)/gm,"> >")})}function c(e){return e=e.replace(/^[\t\r\n]+|[\t\r\n]+$/g,""),e=e.replace(/\n\s+\n/g,"\n\n"),e=e.replace(/\n{3,}/g,"\n\n")}for(var o=[{patterns:"p",replacement:function(e,t,n){return n?"\n\n"+n+"\n":""}},{patterns:"br",type:"void",replacement:"\n"},{patterns:"h([1-6])",replacement:function(e,t,n,r){for(var a="",c=0;t>c;c++)a+="#";return"\n\n"+a+" "+r+"\n"}},{patterns:"hr",type:"void",replacement:"\n\n* * *\n"},{patterns:"a",replacement:function(e,t,r){var a=t.match(n("href")),c=t.match(n("title"));return a?"["+r+"]("+a[1]+(c&&c[1]?' "'+c[1]+'"':"")+")":e}},{patterns:["b","strong"],replacement:function(e,t,n){return n?"**"+n+"**":""}},{patterns:["i","em"],replacement:function(e,t,n){return n?"_"+n+"_":""}},{patterns:"code",replacement:function(e,t,n){return n?"`"+n+"`":""}},{patterns:"img",type:"void",replacement:function(e,t){var r=t.match(n("src")),a=t.match(n("alt")),c=t.match(n("title"));return"!["+(a&&a[1]?a[1]:"")+"]("+r[1]+(c&&c[1]?' "'+c[1]+'"':"")+")"}}],p=0,i=o.length;i>p;p++)if("string"==typeof o[p].patterns)e=t(e,{tag:o[p].patterns,replacement:o[p].replacement,type:o[p].type});else for(var l=0,u=o[p].patterns.length;u>l;l++)e=t(e,{tag:o[p].patterns[l],replacement:o[p].replacement,type:o[p].type});e=e.replace(/<pre\b[^>]*>`([\s\S]*)`<\/pre>/gi,function(e,t){return t=t.replace(/^\t+/g,"  "),t=t.replace(/\n/g,"\n    "),"\n\n    "+t+"\n"}),e=e.replace(/(\d+). /g,"$1\\. ");for(var s=/<(ul|ol)\b[^>]*>(?:(?!<ul|<ol)[\s\S])*?<\/\1>/gi;e.match(s);)e=e.replace(s,function(e){return r(e)});for(var f=/<blockquote\b[^>]*>((?:(?!<blockquote)[\s\S])*?)<\/blockquote>/gi;e.match(f);)e=e.replace(f,function(e){return a(e)});return c(e)};
